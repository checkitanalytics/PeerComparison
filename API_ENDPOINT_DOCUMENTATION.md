# Primary Company Analysis API Endpoint

## Endpoint
`GET /api/primary-company-analysis`

## Description
Returns AI-generated financial analysis for a primary company compared to its peers, including highlighted sub-sections and key metrics.

## Query Parameters

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `ticker` | string | **Yes** | - | Primary company ticker symbol (e.g., "AAPL", "TSLA") |
| `peers` | string | No | Auto-detected | Comma-separated peer tickers (e.g., "MSFT,GOOGL,AMZN") |
| `lang` | string | No | `en` | Language for analysis: `en` (English) or `zh` (Chinese) |

## Example Requests

### Basic Request (Auto-find Peers)
```bash
GET /api/primary-company-analysis?ticker=AAPL
```

### Specify Custom Peers
```bash
GET /api/primary-company-analysis?ticker=TSLA&peers=F,GM,RIVN
```

### Request Chinese Analysis
```bash
GET /api/primary-company-analysis?ticker=NVDA&lang=zh
```

## Response Format

### Success Response (200 OK)
```json
{
  "ticker": "AAPL",
  "period": "2025Q2",
  "analysis": "AAPL: Past-performance takeaway -- 2025Q2.\n- ►► PEER COMPARISON:\n  • Revenue: MSFT +23.0%, GOOGL -2.5%, AMZN -43.9%\n  • OpEx (lower better): MSFT -14.3%, GOOGL -40.6%, AMZN -77.1%\n  • EBIT: MSFT -15.1%, GOOGL -17.5%, AMZN +32.0%\n  • Net income: MSFT -13.9%, GOOGL -16.9%, AMZN +29.0%\n  • Free cash flow: MSFT -4.5%, GOOGL +360.4%, AMZN +7250.9%\n\n- ►► LATEST QUARTER METRICS:\n  • Revenue: QoQ -1.4%; YoY 9.6% → $94.0B.\n  • OpEx ratio: 16.5% (YoY -0.2pp).\n  • EBIT: QoQ -4.7%; YoY 11.2% → $28.2B.\n  • Net income: QoQ -5.3%; YoY 11.9% → $21.2B.\n  • Free cash flow: $22.5B (stable, CV 16%).",
  "language": "en",
  "llm_provider": "deepseek",
  "peers": ["MSFT", "GOOGL", "AMZN"],
  "timestamp": "2025-10-16T05:58:45.984503Z"
}
```

### Error Response (400/404/500)
```json
{
  "error": "Missing required parameter: ticker"
}
```

## Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `ticker` | string | Primary company ticker |
| `period` | string | Latest financial quarter (e.g., "2025Q2") |
| `analysis` | string | Formatted analysis text with highlighted sections |
| `language` | string | Language of the analysis ("en" or "zh") |
| `llm_provider` | string | AI provider used: `deepseek`, `perplexity`, or `local-fallback` |
| `peers` | array | List of peer company tickers included in analysis |
| `timestamp` | string | ISO 8601 timestamp when analysis was generated |

## Analysis Format

The analysis includes highlighted sub-sections using `►►` markers:

### 1. ►► PEER COMPARISON
- Compares primary company against each peer
- Shows percentage differences for:
  - Revenue
  - Operating Expense (OpEx - lower is better)
  - EBIT
  - Net Income
  - Free Cash Flow

### 2. ►► LATEST QUARTER METRICS
- Revenue with QoQ and YoY growth
- OpEx ratio as % of revenue with YoY change
- EBIT with QoQ and YoY growth
- Net Income with QoQ and YoY growth  
- Free Cash Flow with stability indicator (CV%)

## Metrics Included

- **Market Cap** - Current market capitalization
- **Total Revenue** - Quarterly revenue
- **Gross Margin %** - Profit margin
- **Operating Expense** - Operational costs
- **EBIT** - Earnings before interest and tax
- **Net Income** - Bottom-line profit
- **Free Cash Flow** - Cash generation

## Data Source
- Financial data from Yahoo Finance API
- Latest 5 quarters of quarterly financials
- Current market capitalization

## AI Providers (Cascade)
1. **DeepSeek** - Primary provider
2. **Perplexity** - Fallback if DeepSeek unavailable
3. **Local Deterministic** - Final fallback

## Error Codes

| Code | Description |
|------|-------------|
| 400 | Missing or invalid ticker parameter |
| 404 | No data available for ticker or peers not found |
| 500 | Server error during analysis generation |

## Usage Examples

### Python
```python
import requests

response = requests.get(
    'http://localhost:5000/api/primary-company-analysis',
    params={'ticker': 'AAPL', 'peers': 'MSFT,GOOGL', 'lang': 'en'}
)

if response.ok:
    data = response.json()
    print(f"Analysis for {data['ticker']} ({data['period']}):")
    print(data['analysis'])
    print(f"\nPeers analyzed: {', '.join(data['peers'])}")
    print(f"Generated by: {data['llm_provider']}")
```

### cURL
```bash
curl "http://localhost:5000/api/primary-company-analysis?ticker=TSLA&peers=F,GM&lang=en"
```

### JavaScript/Fetch
```javascript
fetch('/api/primary-company-analysis?ticker=NVDA&lang=en')
  .then(res => res.json())
  .then(data => {
    console.log(`${data.ticker} Analysis (${data.period}):`);
    console.log(data.analysis);
    console.log(`Peers: ${data.peers.join(', ')}`);
  });
```

## Notes

- Peer companies are auto-selected using specialty groups (MEGA7, eVTOL, EV) or industry/sector matching
- Chinese translation is provided when `lang=zh` (requires DeepSeek API)
- Analysis uses real financial data from Yahoo Finance
- Response time varies (5-30 seconds) depending on AI provider and data availability
- Market Cap is current value, not quarterly historical data

## Related Endpoints

- `POST /api/find-peers` - Find peer companies
- `POST /api/get-metrics` - Get raw metrics data
- `POST /api/peer-key-metrics-conclusion` - Internal analysis endpoint (POST)
- `GET /api/health` - Check API health and provider status
